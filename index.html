<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Financeiro Pessoal</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ Controle Financeiro Din√¢mico</h1>
            <p>Configure seus gastos e veja os percentuais em tempo real</p>
        </div>
        
        <div class="content">
            <div class="cache-info" id="cache-info">
                üíæ Os Dados s√£o salvo no cache do seu navegador, n√£o coletamos nenhuma informa√ß√£o.
            </div>
            
            <div class="input-section">
                <div class="input-group">
                    <label for="salario">üíµ Renda mensal:</label>
                    <input type="number" id="salario" placeholder="R$ 0,00" min="0" step="0.01">
                </div>
                <div class="btn-container">
                    <button class="reset-btn" onclick="limparCampos()">üîÑ Limpar Todos os Campos</button>
                    <button class="print-btn" onclick="tirarPrint()">üì∏ Salvar como Imagem</button>
                </div>
            </div>
            
            <div id="categories" class="fade-in" style="display: none;">
                <div class="category-input moradia">
                    <div class="category-title">
                        <div class="category-icon" style="background: #45B7D1;">üè†</div>
                        Moradia (25%)
                    </div>
                    <div class="category-explanation">
                        Aluguel, financiamento, condom√≠nio, contas de √°gua, luz, g√°s, IPTU
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label for="moradia-valor">Valor gasto (R$):</label>
                            <input type="number" id="moradia-valor" placeholder="R$ 0,00" min="0" step="0.01">
                        </div>
                        <div class="percentage-display" id="moradia-percent">0%</div>
                    </div>
                </div>
                
                <div class="category-input alimentacao">
                    <div class="category-title">
                        <div class="category-icon" style="background: #FF6B6B;">üçΩÔ∏è</div>
                        Alimenta√ß√£o (10-15%)
                    </div>
                    <div class="category-explanation">
                        Supermercado, feira, delivery e refei√ß√µes fora de casa
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label for="alimentacao-valor">Valor gasto (R$):</label>
                            <input type="number" id="alimentacao-valor" placeholder="R$ 0,00" min="0" step="0.01">
                        </div>
                        <div class="percentage-display" id="alimentacao-percent">0%</div>
                    </div>
                </div>
                
                <div class="category-input transporte">
                    <div class="category-title">
                        <div class="category-icon" style="background: #4ECDC4;">üöó</div>
                        Transporte (10%)
                    </div>
                    <div class="category-explanation">
                        Combust√≠vel, transporte p√∫blico, manuten√ß√£o, seguro, IPVA
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label for="transporte-valor">Valor gasto (R$):</label>
                            <input type="number" id="transporte-valor" placeholder="R$ 0,00" min="0" step="0.01">
                        </div>
                        <div class="percentage-display" id="transporte-percent">0%</div>
                    </div>
                </div>
                
                <div class="category-input gastos-fixos">
                    <div class="category-title">
                        <div class="category-icon" style="background: #96CEB4;">üìÑ</div>
                        Gastos Fixos (5-10%)
                    </div>
                    <div class="category-explanation">
                        Telefonia, internet, assinaturas, escola, plano de sa√∫de, etc.
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label for="gastos-valor">Valor gasto (R$):</label>
                            <input type="number" id="gastos-valor" placeholder="R$ 0,00" min="0" step="0.01">
                        </div>
                        <div class="percentage-display" id="gastos-percent">0%</div>
                    </div>
                </div>
                
                <div class="category-input investimentos">
                    <div class="category-title">
                        <div class="category-icon" style="background: #6C5CE7;">üéØ</div>
                        Investimentos (15%)
                    </div>
                    <div class="category-explanation">
                        Bolsa, fundos, renda fixa, previd√™ncia privada, etc.
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label for="investimentos-valor">Valor investido (R$):</label>
                            <input type="number" id="investimentos-valor" placeholder="R$ 0,00" min="0" step="0.01">
                        </div>
                        <div class="percentage-display" id="investimentos-percent">0%</div>
                    </div>
                </div>
                
                <div class="category-input poupanca">
                    <div class="category-title">
                        <div class="category-icon" style="background: #A0522D;">üíº</div>
                        Poupan√ßa / Reserva (5-10%)
                    </div>
                    <div class="category-explanation">
                        Fundo de emerg√™ncia, viagens futuras, despesas inesperadas
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label for="poupanca-valor">Valor poupado (R$):</label>
                            <input type="number" id="poupanca-valor" placeholder="R$ 0,00" min="0" step="0.01">
                        </div>
                        <div class="percentage-display" id="poupanca-percent">0%</div>
                    </div>
                </div>
                
                <div class="category-input lazer">
                    <div class="category-title">
                        <div class="category-icon" style="background: #FECA57;">üõçÔ∏è</div>
                        Lazer / Pessoal (10%)
                    </div>
                    <div class="category-explanation">
                        Viagens, cinema, hobbies, restaurantes, roupas, autocuidado
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label for="lazer-valor">Valor gasto (R$):</label>
                            <input type="number" id="lazer-valor" placeholder="R$ 0,00" min="0" step="0.01">
                        </div>
                        <div class="percentage-display" id="lazer-percent">0%</div>
                    </div>
                </div>
                
                <div class="category-input doacoes">
                    <div class="category-title">
                        <div class="category-icon" style="background: #FF9500;">üéÅ</div>
                        Doa√ß√µes (0-5% - Opcional)
                    </div>
                    <div class="category-explanation">
                        Caridade, d√≠zimos, ajuda familiar, etc.
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label for="doacoes-valor">Valor doado (R$):</label>
                            <input type="number" id="doacoes-valor" placeholder="R$ 0,00" min="0" step="0.01">
                        </div>
                        <div class="percentage-display" id="doacoes-percent">0%</div>
                    </div>
                </div>
            </div>
            
            <div id="results" class="results-section" style="display: none;">
                <div class="credit-card-section">
                    <div class="credit-card-title">üí≥ Limite Sugerido do Cart√£o</div>
                    <div class="credit-limit" id="limite-cartao">R$ 0,00</div>
                    <div class="credit-breakdown">
                        Baseado em Lazer + Gastos Fixos + Alimenta√ß√£o
                    </div>
                </div>
                
                <div class="summary">
                    <div class="summary-card">
                        <h3>üìä Total Alocado</h3>
                        <div class="summary-value" id="total-gasto">R$ 0,00</div>
                        <p>Soma de todas as categorias</p>
                    </div>
                    
                    <div class="summary-card">
                        <h3>üí∞ Saldo Restante</h3>
                        <div class="summary-value" id="saldo-restante">R$ 0,00</div>
                        <p>Renda - Total alocado</p>
                    </div>
                    
                    <div class="summary-card">
                        <h3>üìà Utiliza√ß√£o</h3>
                        <div class="summary-value" id="utilizacao-total">0%</div>
                        <p>Percentual da renda utilizado</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Incluindo html2canvas via CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script>
        const salarioInput = document.getElementById('salario');
        const categoriesDiv = document.getElementById('categories');
        const resultsDiv = document.getElementById('results');
        const cacheInfoDiv = document.getElementById('cache-info');
        
        // Elementos de entrada das categorias
        const inputs = {
            moradia: document.getElementById('moradia-valor'),
            alimentacao: document.getElementById('alimentacao-valor'),
            transporte: document.getElementById('transporte-valor'),
            gastos: document.getElementById('gastos-valor'),
            investimentos: document.getElementById('investimentos-valor'),
            poupanca: document.getElementById('poupanca-valor'),
            lazer: document.getElementById('lazer-valor'),
            doacoes: document.getElementById('doacoes-valor')
        };
        
        // Elementos de exibi√ß√£o dos percentuais
        const percentDisplays = {
            moradia: document.getElementById('moradia-percent'),
            alimentacao: document.getElementById('alimentacao-percent'),
            transporte: document.getElementById('transporte-percent'),
            gastos: document.getElementById('gastos-percent'),
            investimentos: document.getElementById('investimentos-percent'),
            poupanca: document.getElementById('poupanca-percent'),
            lazer: document.getElementById('lazer-percent'),
            doacoes: document.getElementById('doacoes-percent')
        };
        
        // Faixas ideais para cada categoria (em percentual)
        const faixasIdeais = {
            moradia: { min: 20, max: 30, ideal: 25 },
            alimentacao: { min: 10, max: 15, ideal: 12.5 },
            transporte: { min: 8, max: 12, ideal: 10 },
            gastos: { min: 5, max: 10, ideal: 7.5 },
            investimentos: { min: 10, max: 20, ideal: 15 },
            poupanca: { min: 5, max: 10, ideal: 7.5 },
            lazer: { min: 5, max: 15, ideal: 10 },
            doacoes: { min: 0, max: 5, ideal: 2.5 }
        };
        
        // Elementos dos resultados
        const limiteCartao = document.getElementById('limite-cartao');
        const totalGasto = document.getElementById('total-gasto');
        const saldoRestante = document.getElementById('saldo-restante');
        const utilizacaoTotal = document.getElementById('utilizacao-total');
        
        // Chave para salvar no localStorage
        const STORAGE_KEY = 'controle-financeiro-dados-v2';
        
        // Fun√ß√£o para salvar dados no localStorage
        function salvarDados() {
            const dados = {
                salario: salarioInput.value,
                moradia: inputs.moradia.value,
                alimentacao: inputs.alimentacao.value,
                transporte: inputs.transporte.value,
                gastos: inputs.gastos.value,
                investimentos: inputs.investimentos.value,
                poupanca: inputs.poupanca.value,
                lazer: inputs.lazer.value,
                doacoes: inputs.doacoes.value,
                timestamp: new Date().getTime()
            };
            
            localStorage.setItem(STORAGE_KEY, JSON.stringify(dados));
            
            // Mostrar info do cache apenas se houver dados salvos
            if (dados.salario || Object.values(inputs).some(input => input.value)) {
                cacheInfoDiv.style.display = 'block';
            }
        }
        
        // Fun√ß√£o para carregar dados do localStorage
        function carregarDados() {
            try {
                const dadosSalvos = localStorage.getItem(STORAGE_KEY);
                if (dadosSalvos) {
                    const dados = JSON.parse(dadosSalvos);
                    
                    // Verificar se os dados n√£o s√£o muito antigos (opcional - 30 dias)
                    const agora = new Date().getTime();
                    const diasAntigos = (agora - dados.timestamp) / (1000 * 60 * 60 * 24);
                    
                    if (diasAntigos < 30) { // Manter dados por 30 dias
                        salarioInput.value = dados.salario || '';
                        inputs.moradia.value = dados.moradia || '';
                        inputs.alimentacao.value = dados.alimentacao || '';
                        inputs.transporte.value = dados.transporte || '';
                        inputs.gastos.value = dados.gastos || '';
                        inputs.investimentos.value = dados.investimentos || '';
                        inputs.poupanca.value = dados.poupanca || '';
                        inputs.lazer.value = dados.lazer || '';
                        inputs.doacoes.value = dados.doacoes || '';
                        
                        // Mostrar info do cache se houver dados carregados
                        if (dados.salario || Object.values(dados).some(valor => valor && valor !== dados.timestamp)) {
                            cacheInfoDiv.style.display = 'block';
                        }
                        
                        // Recalcular ap√≥s carregar
                        calcularOrcamento();
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar dados do cache:', error);
            }
        }
        
        function formatarMoeda(valor) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                minimumFractionDigits: 2
            }).format(valor);
        }
        
        function calcularOrcamento() {
            const salario = parseFloat(salarioInput.value) || 0;
            
            if (salario > 0) {
                // Mostrar se√ß√µes de categorias e resultados
                categoriesDiv.style.display = 'block';
                resultsDiv.style.display = 'block';
                
                let totalGastoValor = 0;
                
                // Calcular percentuais para cada categoria
                for (const categoria in inputs) {
                    const valor = parseFloat(inputs[categoria].value) || 0;
                    const percentual = salario > 0 ? (valor / salario * 100) : 0;
                    
                    percentDisplays[categoria].textContent = percentual.toFixed(1) + '%';
                    
                    // Aplicar cores baseadas nas faixas ideais
                    const faixa = faixasIdeais[categoria];
                    if (percentual > faixa.max) {
                        percentDisplays[categoria].style.backgroundColor = '#fee';
                        percentDisplays[categoria].style.color = '#e74c3c';
                    } else if (percentual < faixa.min && percentual > 0) {
                        percentDisplays[categoria].style.backgroundColor = '#fff3cd';
                        percentDisplays[categoria].style.color = '#f39c12';
                    } else if (percentual >= faixa.min && percentual <= faixa.max) {
                        percentDisplays[categoria].style.backgroundColor = '#f0f9f0';
                        percentDisplays[categoria].style.color = '#4CAF50';
                    } else {
                        percentDisplays[categoria].style.backgroundColor = '#f8f9fa';
                        percentDisplays[categoria].style.color = '#6c757d';
                    }
                    
                    totalGastoValor += valor;
                }
                
                // Calcular limite do cart√£o (lazer + gastos fixos + alimenta√ß√£o)
                const limiteCartaoValor = (parseFloat(inputs.lazer.value) || 0) + 
                                         (parseFloat(inputs.gastos.value) || 0) + 
                                         (parseFloat(inputs.alimentacao.value) || 0);
                
                // Calcular saldo restante
                const saldoRestanteValor = salario - totalGastoValor;
                const utilizacaoPercentual = salario > 0 ? (totalGastoValor / salario * 100) : 0;
                
                // Atualizar valores na tela
                limiteCartao.textContent = formatarMoeda(limiteCartaoValor);
                totalGasto.textContent = formatarMoeda(totalGastoValor);
                saldoRestante.textContent = formatarMoeda(saldoRestanteValor);
                utilizacaoTotal.textContent = utilizacaoPercentual.toFixed(1) + '%';
                
                // Aplicar cores baseadas no saldo
                if (saldoRestanteValor < 0) {
                    saldoRestante.className = 'summary-value summary-over';
                    utilizacaoTotal.className = 'summary-value summary-over';
                } else if (saldoRestanteValor < salario * 0.1) {
                    saldoRestante.className = 'summary-value summary-remaining';
                    utilizacaoTotal.className = 'summary-value summary-remaining';
                } else {
                    saldoRestante.className = 'summary-value';
                    utilizacaoTotal.className = 'summary-value';
                }
                
            } else {
                categoriesDiv.style.display = 'none';
                resultsDiv.style.display = 'none';
            }
            
            // Salvar dados ap√≥s cada c√°lculo
            salvarDados();
        }
        
        function limparCampos() {
            // Confirmar antes de limpar
            if (confirm('üóëÔ∏è Tem certeza que deseja limpar todos os dados? Esta a√ß√£o n√£o pode ser desfeita.')) {
                // Limpar campos
                salarioInput.value = '';
                for (const categoria in inputs) {
                    inputs[categoria].value = '';
                    percentDisplays[categoria].textContent = '0%';
                    percentDisplays[categoria].style.backgroundColor = '#f8f9fa';
                    percentDisplays[categoria].style.color = '#6c757d';
                }
                
                // Limpar do localStorage
                localStorage.removeItem(STORAGE_KEY);
                
                // Esconder se√ß√µes e info do cache
                categoriesDiv.style.display = 'none';
                resultsDiv.style.display = 'none';
                cacheInfoDiv.style.display = 'none';
                
                // Feedback de sucesso
                alert('‚úÖ Todos os dados foram limpos com sucesso!');
            }
        }
        
        async function tirarPrint() {
            try {
                // Verificar se h√° dados para capturar
                if (categoriesDiv.style.display === 'none') {
                    alert('‚ùå Digite sua renda mensal primeiro para visualizar os dados!');
                    return;
                }
                
                // Desabilitar o bot√£o temporariamente
                const printBtn = document.querySelector('.print-btn');
                const originalText = printBtn.innerHTML;
                printBtn.innerHTML = '‚è≥ Gerando...';
                printBtn.disabled = true;
                
                // Selecionar apenas a √°rea com dados (excluindo bot√µes)
                const elementoParaCapturar = document.querySelector('.container');
                
                // Configura√ß√µes do html2canvas
                const opcoes = {
                    allowTaint: true,
                    useCORS: true,
                    scale: 2, // Melhor qualidade
                    backgroundColor: null,
                    logging: false,
                    width: elementoParaCapturar.offsetWidth,
                    height: elementoParaCapturar.offsetHeight,
                    onclone: function(clonedDoc) {
                        // Remover os bot√µes e info do cache do clone antes de capturar
                        const btnsContainer = clonedDoc.querySelector('.btn-container');
                        const cacheInfo = clonedDoc.querySelector('.cache-info');
                        if (btnsContainer) {
                            btnsContainer.style.display = 'none';
                        }
                        if (cacheInfo) {
                            cacheInfo.style.display = 'none';
                        }
                    }
                };
                
                // Gerar o canvas
                const canvas = await html2canvas(elementoParaCapturar, opcoes);
                
                // Converter para blob e fazer download
                canvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    
                    // Gerar nome do arquivo com data
                    const agora = new Date();
                    const dataFormatada = agora.toLocaleDateString('pt-BR').replace(/\//g, '-');
                    const horaFormatada = agora.toLocaleTimeString('pt-BR').replace(/:/g, '-');
                    const nomeArquivo = `controle-financeiro_${dataFormatada}_${horaFormatada}.png`;
                    
                    link.href = url;
                    link.download = nomeArquivo;
                    link.click();
                    
                    // Limpar URL tempor√°ria
                    URL.revokeObjectURL(url);
                    
                    // Restaurar bot√£o
                    printBtn.innerHTML = originalText;
                    printBtn.disabled = false;
                    
                    // Feedback de sucesso
                    alert('‚úÖ Screenshot salvo com sucesso!');
                    
                }, 'image/png', 0.95);
                
            } catch (error) {
                console.error('Erro ao gerar screenshot:', error);
                alert('‚ùå Erro ao gerar screenshot. Tente novamente.');
                
                // Restaurar bot√£o em caso de erro
                const printBtn = document.querySelector('.print-btn');
                printBtn.innerHTML = 'üì∏ Salvar como Imagem';
                printBtn.disabled = false;
            }
        }
        
        // Event listeners para c√°lculo e salvamento em tempo real
        salarioInput.addEventListener('input', calcularOrcamento);
        
        for (const categoria in inputs) {
            inputs[categoria].addEventListener('input', calcularOrcamento);
        }
        
        // Carregar dados salvos ao inicializar a p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            carregarDados();
        });
        
        // Carregar dados salvos imediatamente (caso o DOMContentLoaded j√° tenha disparado)
        carregarDados();
    </script>
</body>
</html>